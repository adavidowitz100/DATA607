---
title: "Data 607 - Final Project - API Script"
author: "Avery Davidowitz"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
sys.source("C:\\CUNY_SPS\\DATA607\\env_var\\final_project_env.R", envir = knitr::knit_global())
```

## Import Libraries

```{r}
library(httr)
library(jsonlite)
library(tidyverse)
library(DBI)
library(odbc)
library(glue)
```

## Database Connection

You must have RMySQL package installed.

```{r}
#Establish connection to DB
con <- dbConnect(RMySQL::MySQL(), 
                 dbname = "moviedb", 
                 host = D607_FINAL_ENV$AWS_RDS_HOST, 
                 port = 3306,
                 user = D607_FINAL_ENV$AWS_RDS_USER_NAME,
                 password = D607_FINAL_ENV$AWS_RDS_PW)
```

## Query
```{r}
movies <- dbGetQuery(con, "SELECT * FROM MOVIE WHERE rated is null LIMIT 50")
```


## Load API Data
```{r}
for (row in 1:nrow(movies)) {movie <- movies[row,]
    imdbid <- movie[1, 2]
    movieid <- movie[1, 1]
    r <- GET(stringr::str_c('https://www.omdbapi.com/?apikey=', D607_FINAL_ENV$OMDB_API_KEY,"&i=",imdbid))
    if (http_status(r)$category == "Success"){
        json <- httr::content(r, "text")
        api_data <- jsonlite::fromJSON(json, flatten = TRUE)
        
        # load rated into db
        rated <- api_data$Rated
        sql <- glue_sql("UPDATE `MOVIE` SET `rated` = {rated} WHERE `movieid` = {movieid}", .con = con)
        dbSendStatement(con, sql)
        
        # load actors into db
        actor <- api_data$Actors |> 
                 as.list() |>
                 data.frame() |>
                 dplyr::rename(name=1) |>
                 tidyr::separate_rows(name, sep = ",")
        actor$name <- stringr::str_trim(actor$name)
        actor$name <- stringr::str_replace_all(actor$name,"[\'\"]","")
        
        for (act in 1:nrow(actor)){
          actorid_db <- odbc::dbGetQuery(con, paste0("SELECT actorid FROM moviedb.ACTOR WHERE name =           '",actor$name[act],"'")) 
          if (nrow(actorid_db) == 0){
            DBI::dbWriteTable(con, "ACTOR", data.frame(name=actor$name[act]), append = TRUE, row.names = FALSE)
            actorid_db <- odbc::dbGetQuery(con, paste0("SELECT actorid FROM moviedb.ACTOR WHERE name =           '",actor$name[act],"'"))
          }
            DBI::dbWriteTable(con, "MOVIE_ACTOR", data.frame(movieid=movieid, actorid=actorid_db), append = TRUE, row.names = FALSE)
        }
        
         # load directors into db
        director <- api_data$Director |> 
                 as.list() |>
                 data.frame() |>
                 dplyr::rename(director=1) |>
                 tidyr::separate_rows(director, sep = ",")
        director$director <- stringr::str_trim(director$director)
        director$director <- stringr::str_replace_all(director$director,"[\'\"]","")
        
        for (direct in 1:nrow(director)){
         directorid_db <- odbc::dbGetQuery(con, paste0("SELECT directorid FROM moviedb.DIRECTOR WHERE director =           '",director$director[direct],"'")) 
          if (nrow(directorid_db) == 0){
            DBI::dbWriteTable(con, "DIRECTOR", data.frame(director=director$director[direct]), append = TRUE, row.names = FALSE)
            directorid_db <- odbc::dbGetQuery(con, paste0("SELECT directorid FROM moviedb.DIRECTOR WHERE director =           '",director$director[direct],"'")) 
          }
            DBI::dbWriteTable(con, "MOVIE_DIRECTOR", data.frame(movieid=movieid, directorid=directorid_db), append = TRUE, row.names = FALSE)
        }
        
                 # load languages into db
        language <- api_data$Language |> 
                 as.list() |>
                 data.frame() |>
                 dplyr::rename(language=1) |>
                 tidyr::separate_rows(language, sep = ",")
        language$language <- stringr::str_trim(language$language)
        language$language <- stringr::str_replace_all(language$language,"[\'\"]","")
        
        for (lang in 1:nrow(language)){
         languageid_db <- odbc::dbGetQuery(con, paste0("SELECT languageid FROM moviedb.LANGUAGE WHERE language =           '",language$language[lang],"'")) 
          if (nrow(languageid_db) == 0){
            DBI::dbWriteTable(con, "LANGUAGE", data.frame(language=language$language[lang]), append = TRUE, row.names = FALSE)
            languageid_db <- odbc::dbGetQuery(con, paste0("SELECT languageid FROM moviedb.LANGUAGE WHERE language =           '",language$language[lang],"'"))
          }
            DBI::dbWriteTable(con, "MOVIE_LANGUAGE", data.frame(movieid=movieid, languageid=languageid_db), append = TRUE, row.names = FALSE)
        }
    }
    print(paste("Movie titled",movie["title"], "loaded successfully"))
}    
```

